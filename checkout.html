<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout - Pajay Gadgets</title>
    <link rel="stylesheet" href="style.css?v=2">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
</head>

<body>
    <header>
        <nav class="navbar">
            <a href="index.html" class="logo">Pajay Gadgets</a>
            <ul class="nav-links">
                <li><a href="index.html">Home</a></li>
                <li><a href="shop.html">Shop</a></li>
                <li><a href="index.html#about">About</a></li>
                <li><a href="contact.html">Contact</a></li>
                <li id="admin-nav-link" style="display:none;"><a href="admin.html">Admin</a></li>
            </ul>
            <div class="nav-right">
                <div class="auth-links" id="auth-links">
                    <a href="login.html" class="auth-link">Login</a>
                    <a href="register.html" class="auth-link">Register</a>
                </div>
                <div id="user-menu" style="display:none;">
                    <div class="user-menu" onclick="toggleUserMenu(event)">
                        <div class="user-avatar" id="user-avatar"></div>
                        <div class="user-info">
                            <span class="user-greeting">Welcome back</span>
                            <span class="user-name" id="user-name"></span>
                        </div>
                        <div class="user-dropdown">
                            <a href="cart.html"><span class="dropdown-icon">ðŸ›’</span> My Cart</a>
                            <a href="#" onclick="logoutUser(); return false;" class="logout-btn"><span class="dropdown-icon">ðŸšª</span>
                                Logout</a>
                        </div>
                    </div>
                </div>
                <a href="cart.html" class="cart-link">
                    <span>Cart</span>
                    <span class="cart-count">(<span id="cart-count">0</span>)</span>
                </a>
                <button class="hamburger" id="hamburger" aria-label="Toggle menu" onclick="toggleHamburger(event)">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
            </div>
        </nav>
    </header>

    <main>
        <section class="checkout-page">
            <h1>Checkout</h1>
            <div class="checkout-grid">
                <form id="checkout-form" class="checkout-form">
                    <h3>Delivery Information</h3>
                    <div class="form-group">
                        <label for="name">Full Name</label>
                        <input type="text" id="name" required>
                    </div>
                    <div class="form-group">
                        <label for="phone">Phone Number</label>
                        <input type="tel" id="phone" required>
                    </div>
                    <div class="form-group">
                        <label for="email">Email</label>
                        <input type="email" id="email" required>
                    </div>
                    <div class="form-group">
                        <label for="address">Delivery Address</label>
                        <textarea id="address" rows="3" required></textarea>
                    </div>
                    <div class="form-group">
                        <label for="delivery">Delivery Method</label>
                        <select id="delivery" required>
                            <option value="">Select delivery option</option>
                            <option value="pickup">Pickup from Store</option>
                            <option value="dispatch">Dispatch Rider (Contact for pricing)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="payment">Payment Method</label>
                        <select id="payment" required>
                            <option value="">Select payment option</option>
                            <option value="cash">Cash on Delivery</option>
                            <option value="transfer">Bank Transfer</option>
                            <option value="stripe">Stripe Card Payment</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="notes">Order Notes (Optional)</label>
                        <textarea id="notes" rows="2"></textarea>
                    </div>
                </form>
                <div class="cart-summary">
                    <h3>Order Summary</h3>
                    <div id="checkout-items"></div>
                    <div class="cart-summary-row">
                        <span>Subtotal</span>
                        <span id="checkout-subtotal">â‚¦0</span>
                    </div>
                    <div class="cart-summary-row">
                        <span>Delivery</span>
                        <span>To be confirmed</span>
                    </div>
                    <div class="cart-summary-row cart-summary-total">
                        <span>Total</span>
                        <span id="checkout-total">â‚¦0</span>
                    </div>
                    <button type="submit" form="checkout-form" class="btn" style="width:100%; margin-top:1.5rem;">Place
                        Order</button>
                </div>
            </div>
        </section>
    </main>

    <footer>
        <p>&copy; 2024 Pajay Gadgets. All rights reserved.</p>
    </footer>

    <script src="products.js"></script>
    <script src="script.js"></script>
    <script>
        // Check if user is logged in before showing checkout
        document.addEventListener('DOMContentLoaded', function () {
            const currentUser = JSON.parse(sessionStorage.getItem('dondad_currentUser'));
            if (!currentUser) {
                alert('Please login to proceed to checkout.');
                window.location.href = 'login.html';
                return;
            }

            const params = new URLSearchParams(window.location.search);
            const paymentState = params.get('payment');
            if (paymentState === 'stripe_success') {
                alert('Payment successful. Your order has been confirmed.');
                window.location.href = 'index.html';
                return;
            }
            if (paymentState === 'stripe_cancel') {
                alert('Stripe payment was canceled. You can retry payment from checkout.');
            }

            // Show admin link only for admin users
            const adminLink = document.getElementById('admin-nav-link');
            if (currentUser.role === 'admin' && adminLink) {
                adminLink.style.display = 'block';
            }

            // User is logged in - initialize page
            initCheckoutPage();
            initHamburger();
            updateAuthUI();
            updateCartCount();
        });

        function logout() {
            sessionStorage.removeItem('dondad_currentUser');
            localStorage.removeItem('dondad_currentUser');
            window.location.href = 'login.html';
        }

        function toggleUserMenu(e) {
            // Prevent the click from propagating to parent elements
            e.stopPropagation();
            
            // Find the user-menu element
            const userMenu = document.querySelector('.user-menu');
            const userDropdown = document.querySelector('.user-dropdown');
            
            console.log('toggleUserMenu clicked, userMenu:', userMenu);
            console.log('Has active class:', userMenu?.classList?.contains('active'));
            
            // Don't toggle if clicking inside the dropdown
            if (userDropdown && userDropdown.contains(e.target)) {
                return;
            }
            
            if (userMenu) {
                userMenu.classList.toggle('active');
                console.log('Toggled active, now has:', userMenu.classList.contains('active'));
            }
        }

        // Close dropdown and hamburger when clicking on the page
        document.addEventListener('click', function(e) {
            // Close user dropdown
            const userMenu = document.querySelector('.user-menu');
            const userDropdown = document.querySelector('.user-dropdown');
            if (userMenu && userDropdown) {
                if (!userMenu.contains(e.target) && !userDropdown.contains(e.target)) {
                    userMenu.classList.remove('active');
                }
            }
            
            // Close hamburger menu
            const hamburger = document.querySelector('.hamburger');
            const navLinks = document.querySelector('.nav-links');
            if (hamburger && navLinks) {
                if (!hamburger.contains(e.target) && !navLinks.contains(e.target)) {
                    hamburger.classList.remove('active');
                    navLinks.classList.remove('active');
                }
            }
        });

        // Toggle hamburger menu
        function toggleHamburger(event) {
            if (event) {
                event.preventDefault();
                event.stopPropagation();
            }
            const hamburger = document.getElementById('hamburger');
            const navLinks = document.querySelector('.nav-links');
            if (hamburger && navLinks) {
                hamburger.classList.toggle('active');
                navLinks.classList.toggle('active');
                console.log('Hamburger toggled, active:', hamburger.classList.contains('active'));
            }
        }

        function initHamburger() {
            const hamburger = document.querySelector('.hamburger');
            const navLinks = document.querySelector('.nav-links');
            console.log('Hamburger element:', hamburger);
            console.log('NavLinks element:', navLinks);
            if (hamburger && navLinks) {
                // Toggle menu function
                const toggleMenu = function (e) {
                    e.preventDefault();
                    e.stopPropagation();
                    hamburger.classList.toggle('active');
                    navLinks.classList.toggle('active');
                    console.log('Hamburger clicked, active class:', hamburger.classList.contains('active'));
                };

                // Support both click and touch events for mobile
                hamburger.addEventListener('click', toggleMenu);
                hamburger.addEventListener('touchstart', toggleMenu, {
                    passive: false
                });

                // Close menu when clicking outside
                document.addEventListener('click', function (e) {
                    if (navLinks.classList.contains('active') &&
                        !navLinks.contains(e.target) &&
                        !hamburger.contains(e.target)) {
                        hamburger.classList.remove('active');
                        navLinks.classList.remove('active');
                    }
                });

                // Close menu when clicking on a nav link
                navLinks.querySelectorAll('a').forEach(function (link) {
                    link.addEventListener('click', function () {
                        hamburger.classList.remove('active');
                        navLinks.classList.remove('active');
                    });
                });
            } else {
                console.error('Hamburger or navLinks not found!');
            }
        }

        function initCheckoutPage() {
            const currentUser = JSON.parse(sessionStorage.getItem('dondad_currentUser'));
            if (!currentUser) {
                window.location.href = 'login.html';
                return;
            }
            
            const userId = currentUser._id || currentUser.id;
            
            // Fetch cart from API
            fetch(`/api/cart/${userId}`, {
                credentials: "include"
            })
                .then(r => r.json())
                .then(cartItems => {
                    const itemsContainer = document.getElementById('checkout-items');
                    const totalEl = document.getElementById('checkout-total');
                    const subtotalEl = document.getElementById('checkout-subtotal');

                    if (cartItems.length === 0) {
                        window.location.href = 'shop.html';
                        return;
                    }

                    itemsContainer.innerHTML = cartItems.map(item => `
                        <div class="cart-summary-row">
                            <span>${item.productId?.name || 'Product'} x${item.qty}</span>
                            <span>â‚¦${((item.unitPrice || item.productId?.price || 0) * item.qty).toLocaleString()}</span>
                        </div>
                    `).join('');

                    const total = cartItems.reduce((sum, item) => sum + ((item.unitPrice || item.productId?.price || 0) * item.qty), 0);
                    totalEl.textContent = 'â‚¦' + total.toLocaleString();
                    subtotalEl.textContent = 'â‚¦' + total.toLocaleString();
                })
                .catch(() => {
                    window.location.href = 'shop.html';
                });

            document.getElementById('checkout-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const currentUser = JSON.parse(sessionStorage.getItem('dondad_currentUser'));
                if (!currentUser) {
                    alert('Please login to place an order');
                    window.location.href = 'login.html';
                    return;
                }
                
                // Get cart items
                const cartResponse = await fetch(`/api/cart/${currentUser._id || currentUser.id}`, {
                    credentials: "include"
                });
                const cartItems = await cartResponse.json();
                
                if (cartItems.length === 0) {
                    alert('Your cart is empty');
                    return;
                }
                
                // Prepare order data
                const paymentMethod = document.getElementById('payment').value;
                const orderData = {
                    userId: currentUser._id || currentUser.id,
                    userName: document.getElementById('name').value,
                    userEmail: document.getElementById('email').value,
                    userPhone: document.getElementById('phone').value,
                    items: cartItems.map(item => ({
                        productId: item.productId,
                        productName: item.productName || item.productId?.name || 'Product',
                        productImage: item.productId?.image || '',
                        qty: item.qty,
                        unitPrice: item.unitPrice,
                        selectedVariant: item.selectedVariant
                    })),
                    deliveryInfo: {
                        address: document.getElementById('address').value,
                        method: document.getElementById('delivery').value,
                        notes: document.getElementById('notes').value
                    },
                    paymentMethod,
                    subtotal: getCartTotal()
                };
                
                try {
                    const response = await fetch('/api/orders', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: "include",
                        body: JSON.stringify(orderData)
                    });
                    
                    const result = await response.json();
                    if (result.success) {
                        if (paymentMethod === 'stripe') {
                            const stripeResp = await fetch('/api/payment/stripe/checkout', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    email: orderData.userEmail,
                                    amount: orderData.subtotal,
                                    orderId: result.order._id
                                })
                            });
                            const stripeData = await stripeResp.json();
                            if (stripeResp.ok && stripeData.success && stripeData.url) {
                                window.location.href = stripeData.url;
                                return;
                            }
                            alert(stripeData.error || 'Failed to start Stripe payment');
                            return;
                        }

                        alert('Thank you for your order! Order ID: ' + result.order._id + '\nWe will contact you shortly to confirm.');
                        window.location.href = 'index.html';
                    } else {
                        alert('Failed to place order. Please try again.');
                    }
                } catch (error) {
                    console.error('Order error:', error);
                    alert('Error placing order. Please try again.');
                }
            });
        }
    </script>
</body>

</html>

